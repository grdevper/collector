/*! tog-collector - v1.0.0 - 2019/12/19 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("core-js/modules/es.array.concat"),require("core-js/modules/es.parse-int"),require("querystring"),require("core-js/modules/es.array.filter"),require("core-js/modules/web.dom-collections.for-each")):"function"==typeof define&&define.amd?define(["core-js/modules/es.array.concat","core-js/modules/es.parse-int","querystring","core-js/modules/es.array.filter","core-js/modules/web.dom-collections.for-each"],t):(e=e||self).TogCollector=t(null,null,e.qs)}(this,(function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}n=n&&n.hasOwnProperty("default")?n.default:n;var h={init:function(){this.currentUrl=null,this._rewriteJump(),this._initListener()},_initListener:function(){var e=this;window.addEventListener("load",(function(t){e.currentUrl=window.location.href,e.enterPageTime=(new Date).getTime()})),document.addEventListener("visibilitychange",(function(e){})),window.addEventListener("pushstate",(function(e){})),window.addEventListener("replacestate",(function(e){})),window.addEventListener("popstate",(function(e){})),window.addEventListener("beforeunload",(function(t){e.leavePageTime=(new Date).getTime()}))},_rewriteJump:function(){var e=function(e){var t=window.history[e];return function(){var n=t.apply(this,arguments),i=new Event(e.toLowerCase());return i.arguments=arguments,window.dispatchEvent(i),n}};window.history.pushState=e("pushState"),window.history.replaceState=e("replaceState")},getPageUrl:function(){return this.currentUrl}},d=function(){function e(){i(this,e),this._events=Object.create(null)}return o(e,[{key:"addListener",value:function(e,t,n){this._events||(this._events=Object.create(null)),this._events[e]?n?this._events[e].unshift(t):this._events[e].push(t):this._events[e]=[t]}},{key:"removeListener",value:function(e,t){Array.isArray(this._events[e])&&(t?this._events[e]=this._events[e].filter((function(e){return e!==t&&e.origin!==t})):delete this._events[e])}},{key:"once",value:function(e,t){var n=this,i=function(){for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];t.apply(n,r),n.removeListener(e,t)};i.origin=t,this.addListener(e,i)}},{key:"emit",value:function(e){for(var t=this,n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];Array.isArray(this._events[e])&&this._events[e].forEach((function(e){e.apply(t,i)}))}}]),e}(),v="userInfo";return function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t),e=f(this,u(t).call(this,n));var r=n.data,o=n.config;return e.defaultData=r,e.data=r||{},e.config=c({},{url:"",timeInterval:60,dataSize:10,transformRequest:null},{},o),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,e),o(t,[{key:"setConfig",value:function(e){this.config=c({},this.config,{},e)}},{key:"getConfig",value:function(){return this.config}},{key:"setData",value:function(e){this.data=c({},this.data,{},e)}},{key:"setDefaultData",value:function(e){this.defaultData=c({},this.defaultData,{},e)}},{key:"getData",value:function(){return this.data}},{key:"_isExcMaxSize",value:function(){var e=this.config.dataSize,t=1024*parseInt(e);return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf-8",n=new TextEncoder(t);return n.encode(e).length}(JSON.stringify(this.data))>t}},{key:"_sendDataByImg",value:function(e,t){this.xhrImg||(this.xhrImg=new Image),this.xhrImg.src="".concat(e,"?").concat(t,"&time=").concat((new Date).getTime())}},{key:"sendCollectData",value:function(){var e=this.config,t=this.data,i=e.url,r=e.transformRequest;if(this._isExcMaxSize())this.data=this.defaultData;else{var o=r?r(t):n.stringify(t);window.ActiveXObject||"ActiveXObject"in window?this._sendDataByImg(i,o):navigator.sendBeacon(i,o)}}},{key:"_timeInterval",value:function(){var e=this,t=this.config.timeInterval;setInterval((function(){e.sendCollectData()}),t)}}],[{key:"getInstance",value:function(e){return this.instance||(this.instance=new t(e)),this.instance}}]),t}(function(){function e(t){i(this,e);var n=t.userInfo,r=t.deviceInfo;this.options=t,this.userInfo=n||{},this.deviceInfo=r||{},this.isMobile=!0,window&&this.init()}return o(e,[{key:"init",value:function(){this._collectEvents(),this._collectDeviceInfo(),this._collectUserInfo(),this._collectErrors(),this._collectCurrentPage(),this._collectPerformance(),this.rewriteSetItem()}},{key:"_collectEvents",value:function(){this.eventEmitter=new d}},{key:"rewriteSetItem",value:function(){var e=this;if(this.isMobile){var t=localStorage.setItem;localStorage.setItem=function(e,n){var i=new Event("l_setItem");i.key=e,t.apply(this,arguments),window.dispatchEvent(i)},window.addEventListener("l_setItem",(function(t){t.key===v&&(e.userInfo=localStorage.getItem(v)||{})}))}else{var n=sessionStorage.setItem;sessionStorage.setItem=function(e,t){var i=new Event("s_setItem");i.key=e,n.apply(this,arguments),window.dispatchEvent(i)},window.addEventListener("s_setItem",(function(t){t.key===v&&(e.userInfo=sessionStorage.getItem(v)||{})}))}}},{key:"_collectUserInfo",value:function(){this.isMobile?this.userInfo=window?localStorage.getItem("userInfo"):this.userInfo:this.userInfo=window?sessionStorage.getItem("userInfo"):this.userInfo}},{key:"_collectDeviceInfo",value:function(){this.deviceInfo=window?window.navigator:this.deviceInfo}},{key:"_collectCurrentPage",value:function(){h.init()}},{key:"_collectPerformance",value:function(){this.performance=window?window.performance:{}}},{key:"_collectErrors",value:function(){window.onerror=function(e){}}}]),e}())}));
